# FeishuMind 技术架构规范

**版本**: 1.0.0
**最后更新**: 2026-02-06
**负责人**: Claude Code + 人工审核

## 🏗️ 整体架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   飞书 IM    │  │   Web UI     │  │  API 调用    │       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │
└─────────┼──────────────────┼──────────────────┼──────────────┘
          │                  │                  │
┌─────────┼──────────────────┼──────────────────┼──────────────┐
│         ▼                  ▼                  ▼               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ 飞书 Webhook │  │  FastAPI     │  │  定时任务    │       │
│  │   Handler    │  │   Server     │  │  (APScheduler)│      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │
└─────────┼──────────────────┼──────────────────┼──────────────┘
          │                  │                  │
┌─────────┼──────────────────┼──────────────────┼──────────────┐
│         ▼                  ▼                  ▼               │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                   Agent 核心层 (LangGraph)             │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │   │
│  │  │ State   │  │ Tools   │  │ Memory  │  │ Safety  │  │   │
│  │  │ Manager │  │ Registry│  │  Layer  │  │  Check  │  │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
          │                  │                  │
┌─────────┼──────────────────┼──────────────────┼──────────────┐
│         ▼                  ▼                  ▼               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │    Mem0      │  │    n8n       │  │  External    │       │
│  │  (Memory)    │  │ (Workflows)  │  │  APIs        │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│       │                  │                  │               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │ SQLite/FAISS │  │  Redis Cache │  │ GitHub/飞书  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 技术栈

### 核心框架

| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **后端框架** | FastAPI | 0.104+ | 高性能 API 服务器 |
| **Agent 框架** | LangGraph | 0.0.20+ | 状态机式 Agent 编排 |
| **记忆层** | Mem0 | latest | 持久化记忆 + 反馈闭环 |
| **向量检索** | FAISS | 1.7+ | 本地向量数据库 |
| **工作流引擎** | n8n | 1.0+ | 可视化自动化流程 |

### 数据存储

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **关系数据库** | SQLite (开发) / PostgreSQL (生产) | 结构化数据存储 |
| **缓存** | Redis | 会话缓存、任务队列 |
| **向量存储** | FAISS | 语义检索 |
| **文件存储** | 本地文件系统 | 日志、备份 |

### AI 模型

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **主模型** | Claude 3.5 Sonnet | 复杂推理、对话 |
| **备选模型** | Llama-3-8B (本地量化) | 成本优化 |
| **Embedding** | HuggingFace BGE | 语义向量 |

### 部署运维

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **容器化** | Docker + Docker Compose | 服务编排 |
| **反向代理** | NGINX | 负载均衡、SSL |
| **监控** | Prometheus + Grafana | 性能监控 |
| **日志** | Sentry | 错误追踪 |
| **CI/CD** | GitHub Actions | 自动化测试部署 |

## 📦 项目结构

```
feishumind/
├── src/                      # 源代码
│   ├── api/                  # FastAPI 接口
│   │   ├── __init__.py
│   │   ├── main.py           # FastAPI 应用入口
│   │   ├── routes/           # 路由定义
│   │   │   ├── webhook.py    # 飞书 Webhook
│   │   │   ├── agent.py      # Agent 交互
│   │   │   └── health.py     # 健康检查
│   │   └── middleware/       # 中间件
│   │       ├── auth.py       # JWT 认证
│   │       └── logging.py    # 日志中间件
│   ├── agent/                # Agent 核心层
│   │   ├── __init__.py
│   │   ├── graph.py          # LangGraph 状态机
│   │   ├── state.py          # 状态定义
│   │   ├── tools/            # 工具注册
│   │   │   ├── github.py     # GitHub 集成
│   │   │   ├── calendar.py   # 日历操作
│   │   │   ├── resilience.py # 韧性辅导
│   │   │   └── skill_gen.py  # 技能生成
│   │   └── prompts/          # Prompt 模板
│   │       ├── system.py     # 系统提示
│   │       └── tools.py      # 工具提示
│   ├── memory/               # 记忆层
│   │   ├── __init__.py
│   │   ├── config.py         # Mem0 配置
│   │   ├── storage.py        # 存储抽象层
│   │   └── feedback.py       # 反馈机制
│   ├── integrations/         # 外部集成
│   │   ├── __init__.py
│   │   ├── feishu/           # 飞书 SDK
│   │   │   ├── bot.py
│   │   │   ├── card.py
│   │   │   └── api.py
│   │   └── github/           # GitHub API
│   │       └── trending.py
│   ├── workflows/            # n8n 工作流定义
│   │   └── json/             # 导出的 JSON 文件
│   └── utils/                # 工具函数
│       ├── __init__.py
│       ├── logger.py
│       └── config.py
├── tests/                    # 测试
│   ├── unit/                 # 单元测试
│   ├── integration/          # 集成测试
│   └── e2e/                  # 端到端测试
├── docs/                     # 文档
│   ├── spec/                 # 规范文档 (本文件)
│   ├── todo/                 # 任务追踪
│   └── api/                  # API 文档
├── deployments/              # 部署配置
│   ├── docker/               # Dockerfile
│   ├── kubernetes/           # K8s 配置 (可选)
│   └── nginx/                # NGINX 配置
├── scripts/                  # 脚本
│   ├── setup.sh              # 环境初始化
│   └── deploy.sh             # 部署脚本
├── .env.example              # 环境变量模板
├── .gitignore
├── docker-compose.yml
├── pyproject.toml            # Poetry 依赖管理
├── CLAUDE.md                 # Claude Code 项目记忆
└── README.md
```

## 🔄 核心流程

### 1. 飞书消息处理流程

```
用户消息 → 飞书 Webhook → FastAPI Handler
    ↓
Agent State Manager (LangGraph)
    ↓
┌──────────────────────────────┐
│  1. NLP 解析 (spaCy)         │
│  2. 意图识别                 │
│  3. 实体提取 (事件/情绪)     │
│  4. 记忆检索 (Mem0)          │
└──────────────────────────────┘
    ↓
工具调用 (GitHub/日历/韧性辅导)
    ↓
半自主守门员 (Human Approval)
    ↓
执行 + 反馈闭环 (Mem0 Score)
    ↓
飞书卡片响应
```

### 2. 记忆存储与检索流程

```
输入数据 (事件/偏好/情绪)
    ↓
┌──────────────────────────────┐
│  脱敏处理                    │
│  - 移除 PII                  │
│  - 模糊化敏感信息            │
└──────────────────────────────┘
    ↓
Mem0 存储引擎
    ├─> 精确任务 (SQLite)
    └─> 模糊情绪 (FAISS 向量)
    ↓
反馈评分 (0-1)
    ↓
动态优化 (Score < 0.8 → 重新 Prompt)
```

### 3. 定时任务流程

```
APScheduler (Cron)
    ↓
┌──────────────────────────────┐
│  每天 9:00 GitHub 热门推送   │
│  每小时 扫描日历事件         │
│  每周 周报情绪复盘           │
└──────────────────────────────┘
    ↓
Agent 生成内容
    ↓
用户偏好检索 (Mem0)
    ↓
飞书批量发送
    ↓
反馈收集 (点赞/修改)
```

## 🔐 安全架构

### 认证授权

| 层级 | 机制 | 说明 |
|------|------|------|
| **API 层** | JWT Token | 过期时间 1h，刷新机制 |
| **Webhook** | 飞书签名验证 | 验证请求来源 |
| **敏感操作** | 二次确认 | 人工审核守门员 |

### 数据隐私

| 数据类型 | 存储策略 | 上传策略 |
|---------|---------|---------|
| **任务/事件** | 本地 SQLite | 脱敏后上传 LLM |
| **情绪记录** | 本地加密 | 仅上传统计特征 |
| **用户偏好** | 本地 + 加密 | 用户明确同意后 |
| **对话历史** | 本地存储 | 不上传 |

### 安全措施

1. **沙箱隔离**: Docker 容器隔离
2. **网络限制**: UFW 防火墙，仅开放必要端口
3. **审计日志**: Sentry 记录所有敏感操作
4. **内容过滤**: Prompt 工程过滤有害回复
5. **备份恢复**: 每日自动备份，7 天保留

## 📊 监控指标

### 技术指标

| 指标 | 目标值 | 告警阈值 |
|------|--------|---------|
| **API 响应时间** | <2s | >5s |
| **系统可用性** | >99.5% | <99% |
| **Token 消耗** | <1000/用户/月 | >1500 |
| **错误率** | <1% | >5% |
| **内存使用** | <4GB | >6GB |

### 业务指标

| 指标 | 监控方式 |
|------|---------|
| **日活用户** | 飞书 Webhook 统计 |
| **技能使用次数** | Mem0 操作计数 |
| **反馈评分** | Mem0 Score 平均值 |
| **转化率** | SaaS 订阅统计 |

## 🚀 部署架构

### 开发环境

```yaml
services:
  fastapi:
    build: .
    ports: ["8000:8000"]
    environment:
      - ENV=development
      - DEBUG=true
    volumes:
      - ./src:/app/src

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  n8n:
    image: n8nio/n8n
    ports: ["5678:5678"]
```

### 生产环境

```yaml
services:
  fastapi:
    image: feishumind:latest
    restart: always
    environment:
      - ENV=production
    depends_on:
      - redis
      - postgres

  nginx:
    image: nginx:alpine
    ports: ["443:443"]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf

  prometheus:
    image: prom/prometheus
    ports: ["9090:9090"]

  grafana:
    image: grafana/grafana
    ports: ["3001:3000"]
```

## 📝 技术债务

### 已知限制

1. **并发处理**: 当前单进程，未来需 Celery 队列
2. **向量检索**: FAISS 单机，未来需 Pinecone 云服务
3. **模型成本**: Claude API 按量付费，需本地模型备选

### 优化方向

1. **性能优化**: Redis 缓存命中率 >80%
2. **成本优化**: 本地 Llama 模型处理简单任务
3. **扩展性**: 微服务化，拆分 Agent 和 API 层

---

**下一步**: 阅读 [API 接口规范](./02-api-spec.md) 了解接口设计。
