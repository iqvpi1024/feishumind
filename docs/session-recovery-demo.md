# 会话恢复演示

**目的**: 演示如何在上下文丢失或连接断开后快速恢复工作

---

## 🎬 场景模拟

### 场景 1: 上下文达到限制

**问题**:
```
你正在开发 W1-01 FastAPI 基础框架，已经完成了 3/5 个子任务。
突然收到提示："上下文即将达到限制，建议开始新会话"
```

**解决**:
```
1. Claude Code 自动保存状态到 docs/current-status.md
2. 输出：<会话存档> 状态已保存，可随时用"继续任务"恢复
3. 你关闭当前会话，开启新会话
4. 在新会话中说："继续任务"
5. Claude Code 读取 current-status.md，恢复到 W1-01 (60%)
6. 继续完成剩余 2 个子任务
```

### 场景 2: 网络连接中断

**问题**:
```
你正在实现 W1-02 记忆层，突然网络断开，连接超时。
重新连接后，Claude Code 丢失了所有上下文。
```

**解决**:
```
1. 新会话启动
2. 你说："继续任务"
3. Claude Code 自动执行：
   - 读取 docs/current-status.md
   - 发现当前任务：W1-02 记忆层实现 (40%)
   - 读取 docs/spec/01-architecture.md 了解架构
   - 读取 docs/spec/03-coding-standards.md 了解规范
   - 输出："已恢复会话，正在继续 W1-02 记忆层实现..."
4. 继续完成剩余工作
```

### 场景 3: 手动切换会话

**问题**:
```
你需要在不同设备/会话间切换工作。
```

**解决**:
```
设备 A (上午):
- 完成 W1-01 的 3 个子任务
- 保存状态到 docs/current-status.md

设备 B (下午):
- 新会话启动
- 运行：bash scripts/restore-session.sh
- 查看当前状态
- 说："继续任务"
- Claude Code 恢复到相同进度
```

---

## 🧪 实际测试

### 测试步骤

1. **模拟工作中断**
```bash
# 假设你正在工作
echo "工作中... 完成 W1-01 的 3 个子任务"
```

2. **保存状态**
```bash
# Claude Code 自动更新 docs/current-status.md
# 内容包括：
# - 当前任务：W1-01
# - 进度：60%
# - 已完成：3/5 子任务
```

3. **模拟新会话**
```bash
# 运行恢复脚本
bash scripts/restore-session.sh
```

**预期输出**:
```
==========================================
  FeishuMind 会话恢复
==========================================

📅 最后更新: 2026-02-06 14:30
📍 当前阶段：Phase 2 - 核心开发 (15%)
🔄 当前任务：W1-01 FastAPI 基础框架
📊 进度：60% (3/5 子任务完成)

➡️  下一步：
完成健康检查端点和日志中间件

==========================================
  快速命令（复制粘贴给 Claude Code）
==========================================

🔄 继续当前任务：
   继续任务
```

4. **恢复工作**
```bash
# 对 Claude Code 说：
继续任务
```

**预期行为**:
```
Claude Code:
✅ 读取 docs/current-status.md
✅ 确认当前任务：W1-01 (60%)
✅ 读取相关规范文档
✅ 询问："是否继续 W1-01 FastAPI 基础框架？"
你：是
Claude Code: 继续完成剩余子任务...
```

---

## ✅ 验证清单

恢复机制正常工作的标志：

- [ ] `docs/current-status.md` 存在且内容完整
- [ ] `scripts/restore-session.sh` 能正常运行
- [ ] 新会话能正确读取状态
- [ ] 状态信息准确（任务ID、进度、下一步）
- [ ] 恢复后能继续工作而不重复已完成的工作

---

## 🔧 调试技巧

### 如果恢复失败

**问题 1**: 找不到 current-status.md
```bash
# 解决：从 roadmap.md 重建状态
cp docs/todo/roadmap.md docs/current-status.md
# 手动填写当前任务和进度
```

**问题 2**: 状态信息过期
```bash
# 检查最后更新时间
grep "最后更新" docs/current-status.md

# 如果超过 24 小时，询问用户
# "任务是否还有效？是否需要更新？"
```

**问题 3**: TODO 与状态不一致
```bash
# 以 weekly-sprint.md 为准
grep "W1-01:" docs/todo/weekly-sprint.md
# 更新 current-status.md 匹配
```

---

## 📊 恢复成功率

根据 GLM-4.7 规则 #28-32，恢复机制应达到：

| 指标 | 目标 | 实际 |
|------|------|------|
| **状态完整性** | 100% | ✅ 待测试 |
| **恢复准确率** | >95% | ✅ 待测试 |
| **平均恢复时间** | <30s | ✅ 待测试 |
| **零重复工作** | 100% | ✅ 待测试 |

---

## 💡 最佳实践

1. **频繁保存**: 每完成一个子任务，立即更新 current-status.md
2. **详细记录**: 包含任务ID、进度、遇到的问题、下一步
3. **时间戳**: 始终更新"最后更新"时间
4. **双重同步**: 同时更新 current-status.md 和 weekly-sprint.md
5. **自动化**: 使用脚本辅助（restore-session.sh）

---

**下一步**: 测试恢复机制，说"继续任务"开始实际工作！
