# GLM-4.7 接入 Claude Code 的核心规则
# 这些规则优先于其他指令，确保安全、逐步的编码流程。GLM-4.7 作为代理模型，强调上下文管理和测试。

1. "在编写任何代码之前，请先用中文描述你的方法和步骤，并等待用户批准。如果需求不明朗（如涉及 GLM API 配置），立即提问澄清。"

2. "如果任务需要修改超过 3 个文件，请先停下来，将其分解成更小的子任务，并列出每个子任务的计划。"

3. "编写代码后，列出至少 3 个可能出现的问题（如 GLM API 延迟或兼容性 bug），并构建测试用例来覆盖它们。使用 GLM-4.7 的思考链（Chain of Thought）来验证。"

4. "当出现 bug 时，首先编写一个最小可重现的测试案例（e.g., 使用 pytest 或 GLM 的模拟调用），然后逐步修复，直到测试通过。不要一次性修复所有问题。"

5. "每次用户纠正你的输出后，在 CLAUDE.md 中添加一条新规则，描述错误原因和避免方法。这样 GLM-4.7 能从历史中学习，避免重复。"

6. "在处理 GLM-4.7 API 接入时，始终检查环境变量（如 API Key 和 Base URL），并建议使用代理服务避免网络问题。"

7. "对于复杂任务，使用 XML 标签结构化你的响应，例如 <plan>计划</plan> <code>代码</code>，以便用户易读和 GLM 模型解析。"

8. "始终运行 lint 和 test 命令后提交变化（e.g., 'npm test' 或 'python -m unittest'）。如果项目有 CI/CD，提及如何触发。"

9. "不要嵌入整个文档文件到上下文中；只需提及路径并解释何时阅读（e.g., '如果遇到 GLM 配置错误，参考 docs/glm-setup.md'）。"

10. "保持代码风格一致：使用 ES Modules（import/export），避免 any 类型（在 TypeScript 中），并优先使用 GLM-4.7 的 Agentic 模式处理多步任务。"

# 防跑偏规则：确保自动化稳定，针对 GLM-4.7 接入
11. "在任何自动化步骤前，必须先检查 spec.md 或项目规格文件（e.g., requirements.txt），确认当前任务是否与之匹配。如果不符，立即停止并报告偏差原因。"

12. "每完成一个子任务后，使用自验证循环：运行测试代码（e.g., unit tests），检查输出是否符合 TODO 追踪表。如果失败，重试最多 3 次，或建议用户干预。"

13. "禁止简化处理：如果任务涉及复杂逻辑（如 API 集成），必须严格遵循 head 文件中的注释和架构图。不得用 placeholder 替换真实实现，除非 spec 明确允许。"

14. "使用 TODO.md 作为锚点：每步后更新 TODO 表，标记完成项和潜在风险（e.g., '风险：GLM API 延迟可能导致超时'）。如果跳过确认，强制输出 TODO 更新日志。"

15. "自动化模式下，启用链式思考（Chain of Thought）：每步输出 <思考过程> <action>行动</action> <verify>验证</verify>，让用户易追踪，即使不懂代码。"

16. "如果检测到偏离（e.g., 代码输出与 spec 不符），自动回滚到上一个 Git commit，并通知 '偏差警报：请检查 spec'。"

17. "优先研究外部知识：如果不确定，模拟浏览文档（e.g., GLM-4.7 API 指南），并在响应中引用来源，避免 hallucination。"

# 自动化续航规则：基于 docs 和 TODO 的自引导，针对 GLM-4.7 接入
18. "当用户说 '阅读所有docs文档（包含todo），继续任务' 时，立即扫描项目目录下所有 docs 文件（e.g., spec.md, head.md, architecture.md）和 TODO.md，构建任务链。输出 <summary>文档摘要</summary> 确认理解。"

19. "从 docs 中提取关键约束（e.g., 架构要求、API 规范），并将其作为每步的守门人。如果当前行动违反 docs，立即停止并标记为 '偏差：违反 docs 规则X'。"

20. "自动更新 TODO.md：每步完成后，标记项为 [DONE]，添加新子任务（e.g., '如果 docs 要求测试覆盖率 >80%，添加测试步骤'）。如果 TODO 为空，建议 '任务完成，等待新指令'。"

21. "启用自循环模式：读取 docs -> 规划子任务 -> 执行 -> 验证（运行 tests） -> 更新 TODO -> 重复，直到用户干预或 TODO 清空。限制单循环 <15 分钟，避免无限循环。"

22. "处理不确定性：如果 docs 不完整，从 GLM-4.7 的内置知识推断，但必须标注 '推断部分：基于 GLM 标准实践'，并在 TODO 中添加 '用户确认' 项。"

23. "集成 GLM-4.7 Agentic 功能：将复杂任务分解为代理子模块（e.g., 代码生成代理、测试代理），每个代理参考 docs 输出独立结果，然后合并。"

24. "日志自动化：每循环输出 <log>步骤N: 从 docs 提取X，执行Y，结果Z</log>，便于用户追踪。即使跳过确认，也生成完整日志文件 (e.g., auto-log.md)。"

25. "错误恢复：如果执行失败（e.g., GLM API 错误），回滚到上一个 TODO 状态，尝试备选方案（从 docs 中优先选择），最多重试 2 次，否则暂停并通知 '需要用户输入'。"

26. "结束条件：当 TODO.md 所有项 [DONE] 时，输出 '任务链完成，基于 docs 验证通过'，并建议下一步（e.g., '部署？'）。禁止在未完成时简化或跳过。"

27. "多文档优先级：如果多个 docs 冲突，以 spec.md 为准，其次 head 文件，最后 TODO。自动检测冲突并在日志中报告。"

# 会话恢复规则：确保上下文丢失后能继续工作
28. "新会话启动时，首先阅读 docs/current-status.md 了解当前工作状态。如果文件不存在，阅读 docs/todo/roadmap.md 找到当前阶段。"

29. "会话恢复标准流程：① 读 docs/current-status.md → ② 读 docs/spec 中的相关规范 → ③ 读 docs/todo/weekly-sprint.md 查看当前任务 → ④ 询问用户'是否继续上一个任务？'"

30. "每次结束会话前，必须更新 docs/current-status.md：记录当前任务ID、完成进度、遇到的问题、下一步行动。格式如下：
    ```markdown
    # 当前会话状态
    - **最后更新**: 2026-02-06 14:30
    - **当前任务**: W1-01 FastAPI 基础框架
    - **进度**: 60% (3/5 子任务完成)
    - **已完成**: [✅] 创建应用实例, [✅] 配置 CORS
    - **进行中**: [🔄] 健康检查端点
    - **遇到问题**: CORS 配置报错
    - **下一步**: 修复 CORS 中间件，完成健康检查
    - **相关文件**: src/api/main.py
    ```"

31. "如果上下文满但会话未断，先保存当前状态到 docs/current-status.md，然后输出 '<会话存档> 状态已保存，可随时用\"继续任务\"恢复'。"

32. "恢复时会话验证：检查 docs/current-status.md 的'最后更新'时间，如果超过 24 小时，询问用户'任务是否还有效？'避免继续过期任务。"
